#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Function to reset node data
reset_node_data() {
    local data_dir="${1:-./data}"
    
    echo "═══════════════════════════════════════════"
    echo "  MXD Node Data Reset"
    echo "═══════════════════════════════════════════"
    echo ""
    
    # Check if data directory exists
    if [ ! -d "$data_dir" ]; then
        echo "Data directory '$data_dir' does not exist. Nothing to reset."
        exit 0
    fi
    
    echo "This will delete the following data:"
    echo "  - Peer table data"
    echo "  - Rapid stake table data"
    echo "  - Blockchain data (blocks, UTXO database)"
    echo ""
    echo "Data directory: $data_dir"
    echo ""
    
    # List contents before deletion
    if [ -d "$data_dir" ]; then
        echo "Current contents:"
        ls -la "$data_dir" 2>/dev/null || echo "  (empty or inaccessible)"
        echo ""
    fi
    
    read -p "Are you sure you want to reset all node data? (y/N): " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Reset cancelled."
        exit 0
    fi
    
    echo ""
    echo "Resetting node data..."
    
    # Remove UTXO database
    if [ -d "$data_dir/utxo.db" ]; then
        echo "  Removing UTXO database..."
        rm -rf "$data_dir/utxo.db"
    fi
    
    # Remove blockchain database (if separate)
    if [ -d "$data_dir/blockchain.db" ]; then
        echo "  Removing blockchain database..."
        rm -rf "$data_dir/blockchain.db"
    fi
    
    # Remove blocks database
    if [ -d "$data_dir/blocks.db" ]; then
        echo "  Removing blocks database..."
        rm -rf "$data_dir/blocks.db"
    fi
    
    # Remove peers database
    if [ -d "$data_dir/peers.db" ]; then
        echo "  Removing peers database..."
        rm -rf "$data_dir/peers.db"
    fi
    
    # Remove DHT state
    if [ -f "$data_dir/dht_state.json" ]; then
        echo "  Removing DHT state..."
        rm -f "$data_dir/dht_state.json"
    fi
    
    # Remove any other .db directories
    for db_dir in "$data_dir"/*.db; do
        if [ -d "$db_dir" ]; then
            echo "  Removing $(basename "$db_dir")..."
            rm -rf "$db_dir"
        fi
    done
    
    # Remove any state files
    for state_file in "$data_dir"/*.json "$data_dir"/*.dat "$data_dir"/*.bin; do
        if [ -f "$state_file" ]; then
            echo "  Removing $(basename "$state_file")..."
            rm -f "$state_file"
        fi
    done
    
    echo ""
    echo "Node data reset complete!"
    echo "The node will start fresh on next run."
    exit 0
}

# Check if reset command is provided
if [ "$1" == "-reset" ] || [ "$1" == "--reset" ]; then
    # Use second argument as data directory if provided, otherwise use default
    DATA_DIR="${2:-./build/lib/data}"
    reset_node_data "$DATA_DIR"
fi

# Check if network type is provided
if [ -z "$1" ]; then
    echo "Usage: $0 [testnet|mainnet]"
    echo "       $0 -reset [data_dir]   # Reset all node data"
    echo ""
    echo "Examples:"
    echo "  $0 testnet       # Build and run node on testnet"
    echo "  $0 mainnet       # Build and run node on mainnet"
    echo "  $0 -reset        # Reset node data (default: ./build/lib/data)"
    echo "  $0 -reset ./data # Reset node data in specified directory"
    exit 1
fi

NETWORK_TYPE=$1

if [[ "$NETWORK_TYPE" != "testnet" ]] && [[ "$NETWORK_TYPE" != "mainnet" ]]; then
    echo "Error: network type must be 'testnet' or 'mainnet'"
    echo "       Use '$0 -reset' to reset node data"
    exit 1
fi

echo "═══════════════════════════════════════════"
echo "  MXD Node Quick Start"
echo "═══════════════════════════════════════════"
echo ""

echo "Step 1/5: Installing dependencies..."
cd "$SCRIPT_DIR"
./install_dependencies.sh

echo ""
echo "Step 2/5: Cleaning build directory..."
rm -rf build

echo ""
echo "Step 3/5: Building project..."
mkdir build
cd build
cmake ..
make -j$(nproc) mxd_node || make -j$(nproc)
cd ..

echo ""
echo "Step 4/5: Configuring network ($NETWORK_TYPE)..."
CONFIG_FILE="build/lib/default_config.json"
./switch_network.sh "$CONFIG_FILE" "$NETWORK_TYPE"

echo ""
echo "Step 5/5: Starting node..."
echo ""

# Load environment variables if .env exists
if [ -f .env ]; then
    source .env
fi

# Build extra arguments array
EXTRA_ARGS=("${@:2}")

# For testnet, enable HTTP API by default (port 8080) unless already specified
if [[ "$NETWORK_TYPE" == "testnet" ]]; then
    has_http_flag=0
    for arg in "${EXTRA_ARGS[@]}"; do
        if [[ "$arg" == "--http-api" ]]; then
            has_http_flag=1
            break
        fi
    done

    # Only add --http-api if not already specified and MXD_HTTP_API_PORT is not set
    if [[ $has_http_flag -eq 0 && -z "${MXD_HTTP_API_PORT:-}" ]]; then
        EXTRA_ARGS+=(--http-api 8080)
        echo "HTTP API enabled on port 8080 (testnet default)"
    fi
fi

# Run the node and capture exit status
./build/lib/mxd_node "$CONFIG_FILE" "${EXTRA_ARGS[@]}"
EXIT_STATUS=$?

# Check for SIGKILL (exit code 137 = 128 + 9)
if [ $EXIT_STATUS -eq 137 ]; then
    echo ""
    echo "═══════════════════════════════════════════"
    echo "⚠️  WARNING: Process was killed (SIGKILL)"
    echo "═══════════════════════════════════════════"
    echo ""
    echo "The node process was terminated by the system with SIGKILL."
    echo "This typically indicates:"
    echo "  • Out of Memory (OOM) killer"
    echo "  • Container/cgroup memory limit exceeded"
    echo "  • systemd-oomd intervention"
    echo "  • Kubernetes pod eviction"
    echo ""
    echo "To diagnose:"
    echo "  1. Check kernel logs: dmesg -T | tail -100 | grep -i 'oom\\|kill'"
    echo "  2. Check memory limits: ulimit -a"
    echo "  3. Check cgroup limits: cat /sys/fs/cgroup/memory.max"
    echo "  4. If in Docker/K8s: Check pod/container status for OOMKilled"
    echo "  5. Check systemd journal: journalctl -xe | grep -i 'oom\\|kill'"
    echo ""
    echo "Consider:"
    echo "  • Increasing memory limits in your container/VM"
    echo "  • Reducing RocksDB cache sizes in config"
    echo "  • Disabling UPnP (set enable_upnp=false in config)"
    echo ""
    exit 137
fi

exit $EXIT_STATUS
