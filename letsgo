#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Function to reset node data
# Args: $1 = data_dir, $2 = skip_confirm (optional, "true" to skip confirmation)
reset_node_data() {
    local data_dir="${1:-./data}"
    local skip_confirm="${2:-false}"
    
    echo "═══════════════════════════════════════════"
    echo "  MXD Node Data Reset"
    echo "═══════════════════════════════════════════"
    echo ""
    
    echo "This will delete ALL node data:"
    echo "  - Blockchain data (blocks, UTXO database)"
    echo "  - DHT peer table data"
    echo "  - Rapid stake table data"
    echo "  - Node identity keys (will be regenerated on next start)"
    echo ""
    echo "Data directory: $data_dir"
    echo ""
    
    # List contents before deletion
    if [ -d "$data_dir" ]; then
        echo "Current contents:"
        ls -la "$data_dir" 2>/dev/null || echo "  (empty or inaccessible)"
        echo ""
    else
        echo "Data directory '$data_dir' does not exist yet."
        echo ""
    fi
    
    # Skip confirmation if requested (e.g., when used with testnet/mainnet)
    if [ "$skip_confirm" != "true" ]; then
        read -p "Are you sure you want to reset all node data? (y/N): " confirm
        if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
            echo "Reset cancelled."
            return 1
        fi
    fi
    
    echo ""
    echo "Resetting node data..."
    
    # Remove the entire data directory if it exists (this contains all persistent data)
    if [ -d "$data_dir" ]; then
        echo "  Removing data directory: $data_dir"
        rm -rf "$data_dir"
    fi
    
    # Recreate empty data directory
    mkdir -p "$data_dir"
    echo "  Created fresh data directory: $data_dir"
    
    echo ""
    echo "Node data reset complete!"
    echo "The node will start fresh with a new identity."
    return 0
}

# Check if standalone reset command is provided (./letsgo -reset)
if [ "$1" == "-reset" ] || [ "$1" == "--reset" ]; then
    # Use second argument as data directory if provided, otherwise use default
    # The node stores data in ./data relative to where it runs (mxdlib root)
    DATA_DIR="${2:-./data}"
    reset_node_data "$DATA_DIR"
    exit $?
fi

# Check if network type is provided
if [ -z "$1" ]; then
    echo "Usage: $0 [testnet|mainnet] [-reset]"
    echo "       $0 -reset [data_dir]"
    echo ""
    echo "Examples:"
    echo "  $0 testnet           # Build and run node on testnet"
    echo "  $0 mainnet           # Build and run node on mainnet"
    echo "  $0 testnet -reset    # Reset data, then build and run on testnet"
    echo "  $0 -reset            # Reset node data only (default: ./data)"
    echo "  $0 -reset /path/to/data  # Reset node data in specified directory"
    exit 1
fi

NETWORK_TYPE=$1
RESET_FLAG=0

# Check for -reset flag in remaining arguments
for arg in "${@:2}"; do
    if [[ "$arg" == "-reset" ]] || [[ "$arg" == "--reset" ]]; then
        RESET_FLAG=1
        break
    fi
done

if [[ "$NETWORK_TYPE" != "testnet" ]] && [[ "$NETWORK_TYPE" != "mainnet" ]]; then
    echo "Error: network type must be 'testnet' or 'mainnet'"
    echo "       Use '$0 -reset' to reset node data"
    exit 1
fi

echo "═══════════════════════════════════════════"
echo "  MXD Node Quick Start"
echo "═══════════════════════════════════════════"
echo ""

echo "Step 1/5: Installing dependencies..."
cd "$SCRIPT_DIR"
./install_dependencies.sh

echo ""
echo "Step 2/5: Cleaning build directory..."
rm -rf build

echo ""
echo "Step 3/5: Building project..."
mkdir build
cd build
cmake ..
make -j$(nproc) mxd_node || make -j$(nproc)
cd ..

echo ""
echo "Step 4/5: Configuring network ($NETWORK_TYPE)..."
CONFIG_FILE="build/lib/default_config.json"
./switch_network.sh "$CONFIG_FILE" "$NETWORK_TYPE"

# If -reset flag was provided, reset node data before starting
if [ $RESET_FLAG -eq 1 ]; then
    echo ""
    echo "Step 4.5/5: Resetting node data (as requested)..."
    # Reset data in ./data directory (where the node stores all persistent data)
    # Skip confirmation since user explicitly requested reset
    reset_node_data "data" "true"
fi

echo ""
echo "Step 5/5: Starting node..."
echo ""

# Load environment variables if .env exists
if [ -f .env ]; then
    source .env
fi

# Build extra arguments array, filtering out -reset/--reset flags
NODE_ARGS=()
for arg in "${@:2}"; do
    if [[ "$arg" != "-reset" ]] && [[ "$arg" != "--reset" ]]; then
        NODE_ARGS+=("$arg")
    fi
done

# For testnet, enable HTTP API by default (port 8080) unless already specified
if [[ "$NETWORK_TYPE" == "testnet" ]]; then
    has_http_flag=0
    for arg in "${NODE_ARGS[@]}"; do
        if [[ "$arg" == "--http-api" ]]; then
            has_http_flag=1
            break
        fi
    done

    # Only add --http-api if not already specified and MXD_HTTP_API_PORT is not set
    if [[ $has_http_flag -eq 0 && -z "${MXD_HTTP_API_PORT:-}" ]]; then
        NODE_ARGS+=(--http-api 8080)
        echo "HTTP API enabled on port 8080 (testnet default)"
    fi
fi

# Run the node and capture exit status
./build/lib/mxd_node "$CONFIG_FILE" "${NODE_ARGS[@]}"
EXIT_STATUS=$?

# Check for SIGKILL (exit code 137 = 128 + 9)
if [ $EXIT_STATUS -eq 137 ]; then
    echo ""
    echo "═══════════════════════════════════════════"
    echo "⚠️  WARNING: Process was killed (SIGKILL)"
    echo "═══════════════════════════════════════════"
    echo ""
    echo "The node process was terminated by the system with SIGKILL."
    echo "This typically indicates:"
    echo "  • Out of Memory (OOM) killer"
    echo "  • Container/cgroup memory limit exceeded"
    echo "  • systemd-oomd intervention"
    echo "  • Kubernetes pod eviction"
    echo ""
    echo "To diagnose:"
    echo "  1. Check kernel logs: dmesg -T | tail -100 | grep -i 'oom\\|kill'"
    echo "  2. Check memory limits: ulimit -a"
    echo "  3. Check cgroup limits: cat /sys/fs/cgroup/memory.max"
    echo "  4. If in Docker/K8s: Check pod/container status for OOMKilled"
    echo "  5. Check systemd journal: journalctl -xe | grep -i 'oom\\|kill'"
    echo ""
    echo "Consider:"
    echo "  • Increasing memory limits in your container/VM"
    echo "  • Reducing RocksDB cache sizes in config"
    echo "  • Disabling UPnP (set enable_upnp=false in config)"
    echo ""
    exit 137
fi

exit $EXIT_STATUS
