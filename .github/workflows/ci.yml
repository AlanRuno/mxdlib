# CI workflow updated to include printf/fprintf guard in src/
name: MXD Library CI/CD

on:
  push:
    branches: [ main, develop ]
    tags:
      - '*'
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  packages: write

env:
  BUILD_TYPE: Release

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
# Note: Upload may fail if Code Scanning is not enabled for this repository
    # This requires repository admin access to enable in Settings > Security & analysis
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config \
            libssl-dev libsodium-dev librocksdb-dev libcjson-dev \
            libuv1-dev libcurl4-openssl-dev \
            valgrind cppcheck clang-tidy
    
      - name: Set CC/CXX to clang with sanitizers
        if: ${{ matrix.compiler == 'clang' }}
        run: |
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          echo 'CFLAGS=-Wno-deprecated-declarations -fsanitize=address,undefined -fno-omit-frame-pointer -O1' >> $GITHUB_ENV
          echo 'LDFLAGS=-fsanitize=address,undefined' >> $GITHUB_ENV

      - name: "Guard: fail on printf/fprintf/sprintf/vsprintf usage in src/ (excluding logging implementation)"
        run: |
          set +e
          MATCHES=$(grep -RInE '\b(printf|fprintf|sprintf|vsprintf)\s*\(' src/ | grep -v 'src/mxd_logging.c' || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES"
            echo "Found unsafe printf-family usage in src/. Replace with MXD_LOG_* or use snprintf/vsnprintf as appropriate"
            exit 1
          fi

      - name: "Guard: fail on hardcoded secrets patterns"
        run: |
          set +e
          BAD1=$(grep -RIn "0x4D584431" src/ include/ || true)
          BAD2=$(grep -RIn "MXDKeyDerivation" src/ include/ || true)
          BAD3=$(grep -RInE "memset\\s*\\(\\s*[^,]+\\s*,\\s*0xAB\\s*," src/ include/ || true)
          ALL="$BAD1$BAD2$BAD3"
          if [ -n "$ALL" ]; then
            echo "$ALL"
            echo "Found hardcoded secrets or salts. Remove them."
            exit 1
          fi
    

      - name: Install MXD dependencies
        run: ./install_dependencies.sh
    
      - name: Configure CMake
        run: |
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
          cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DENABLE_TESTING=ON -DMXD_WITH_WASI=OFF
    
      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)
    
      - name: Run static analysis
        run: |
          cppcheck --enable=warning,performance,portability --error-exitcode=1 --suppress=missingIncludeSystem --suppress=unusedFunction src/
          find src/ -name "*.c" -exec clang-tidy {} -- -I include/ \;
    
      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure
    
      - name: Run memory tests with Valgrind (gcc only)
        if: ${{ matrix.compiler == 'gcc' }}
        working-directory: build
        run: |
          valgrind --tool=memcheck --leak-check=full --error-exitcode=1 \
            ./lib/mxd_crypto_tests
          valgrind --tool=memcheck --leak-check=full --error-exitcode=1 \
            ./lib/mxd_metrics_tests
      
      - name: Run tests with sanitizers (clang only)
        if: ${{ matrix.compiler == 'clang' }}
        working-directory: build
        run: |
          export ASAN_OPTIONS=detect_leaks=0:halt_on_error=1
          export UBSAN_OPTIONS=print_stacktrace=1:halt_on_error=1
          ./lib/mxd_crypto_tests
          ./lib/mxd_metrics_tests

  performance-test:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - uses: actions/checkout@v4
    
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config \
            libssl-dev libsodium-dev librocksdb-dev libcjson-dev \
            libuv1-dev libcurl4-openssl-dev

      - name: Install MXD dependencies
        run: ./install_dependencies.sh
    
      - name: Build
        run: |
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTING=ON -DMXD_WITH_WASI=OFF
          cmake --build build --config Release -j$(nproc)

      - name: Run performance tests
        working-directory: build
        run: |
          ./lib/mxd_metrics_performance_tests
    
      - name: Performance benchmark
        run: |
          echo "## Performance Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | Completed successfully |" >> $GITHUB_STEP_SUMMARY

  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
    
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: mxdlib:latest
          no-cache: true

      - name: Generate SBOM for source (CycloneDX)
        uses: anchore/sbom-action@v0.15.8
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom-source.cdx.json
          upload-artifact: false
      - name: Generate SBOM for Docker image (CycloneDX)
        uses: anchore/sbom-action@v0.15.8
        with:
          image: mxdlib:latest
          format: cyclonedx-json
          output-file: sbom-image.cdx.json
          upload-artifact: false
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: |
            sbom-source.cdx.json
            sbom-image.cdx.json


      - name: Test Docker image
        run: |
          docker run --rm -d --name mxd-test mxdlib:latest
          sleep 10
          docker logs mxd-test
          docker stop mxd-test


  docker-publish-sign:
    runs-on: ubuntu-latest
    needs: docker-build
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}:latest
      - name: Install cosign
        uses: sigstore/cosign-installer@v3
      - name: Sign container image with cosign (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign --yes ghcr.io/${{ github.repository }}:${{ github.ref_name }} || true
          cosign sign --yes ghcr.io/${{ github.repository }}:latest || true
      - name: Generate SBOM for pushed image (CycloneDX)
        uses: anchore/sbom-action@v0.15.8
        with:
          image: ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          format: cyclonedx-json
          output-file: sbom-image-ghcr.cdx.json
          upload-artifact: false
      - name: Upload SBOM (GHCR image)
        uses: actions/upload-artifact@v4
        with:
          name: sbom-image-ghcr
          path: sbom-image-ghcr.cdx.json

  integration-test:
    runs-on: ubuntu-latest
    needs: docker-build
    
    steps:
      - uses: actions/checkout@v4
      - name: Start test environment
        run: |
          docker compose -f docker-compose.test.yml up -d
          sleep 30
    
      - name: Run integration tests
        run: |
          # Test that containers start successfully
          docker compose -f docker-compose.test.yml ps
          # Test that nodes are running (check logs for startup messages)
          docker logs mxd-node-1 | grep "Node started successfully" || echo "Node 1 startup check"
          docker logs mxd-node-2 | grep "Node started successfully" || echo "Node 2 startup check"
          
          # Test basic container connectivity
          docker exec mxd-node-1 echo "Node 1 responsive"
          docker exec mxd-node-2 echo "Node 2 responsive"
    
      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [security-scan, build-and-test, performance-test, integration-test]
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add actual deployment steps here
    
      - name: Run smoke tests
        run: |
          echo "Running smoke tests on staging..."
          # Add smoke test steps here
